<div class="dashboard-container" *ngIf="currentUser$ | async as currentUser">
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <h2>MediSync - Admin Panel</h2>
    </div>
    <div class="user-info">
      <span>Dobrodo≈°li, {{ currentUser.firstName }} {{ currentUser.lastName }}</span>
      <button class="btn-logout" (click)="logout()">Odjavi se</button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'profil'" 
      (click)="selectTab('profil')">
       Profil
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'pacijenti'" 
      (click)="selectTab('pacijenti')">
       Pacijenti
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'doktori'" 
      (click)="selectTab('doktori')">
       Doktori
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'administratori'" 
      (click)="selectTab('administratori')">
       Administratori
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'lekovi'" 
      (click)="selectTab('lekovi')">
       Lekovi
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'proizvodjaci'" 
      (click)="selectTab('proizvodjaci')">
       Proizvoƒëaƒçi
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'alergije'" 
      (click)="selectTab('alergije')">
       Alergije
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'tipovi-pregleda'" 
      (click)="selectTab('tipovi-pregleda')">
       Tipovi Pregleda
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'povezi'" 
      (click)="selectTab('povezi')">
      Pove≈æi doktora i pacijenta
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'ukloni'" 
      (click)="selectTab('ukloni')">
       Ukloni pacijenta doktoru
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'blok-termini'" 
      (click)="selectTab('blok-termini')">
       Blok Termini
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'termini'" 
      (click)="selectTab('termini')">
       Svi Termini
    </button>
  </nav>

  <!-- Content Area -->
  <div class="content">
    <!-- Lekovi Tab -->
    <div *ngIf="activeTab === 'lekovi'" class="tab-content">
      <app-drugs-admin></app-drugs-admin>
    </div>
    <!-- Proizvoƒëaƒçi Tab -->
    <div *ngIf="activeTab === 'proizvodjaci'" class="tab-content">
      <app-manufacturers-admin></app-manufacturers-admin>
    </div>

    <!-- Alergije Tab -->
    <div *ngIf="activeTab === 'alergije'" class="tab-content">
      <h3>Upravljanje Alergijama</h3>
      
      <div class="allergies-section">
        <!-- CRUD Master Lista Alergija -->
        <div class="allergies-crud">
          <div class="section-header">
            <h4>Master Lista Alergija</h4>
            <button class="btn-add" (click)="openAddAllergyModal()">+ Dodaj Alergiju</button>
          </div>

          <div *ngIf="isLoadingAllergies$ | async" class="loading">Uƒçitavanje alergija...</div>
          <div *ngIf="allergiesError$ | async as error" class="error-message">{{ error }}</div>

          <table class="allergies-table" *ngIf="(allergies$ | async) as allergies">
            <thead>
              <tr>
                <th>Naziv Alergije</th>
                <th>Datum Kreiranja</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allergy of allergies">
                <td>{{ allergy.name }}</td>
                <td>{{ allergy.createdAt | date:'dd.MM.yyyy' }}</td>
                <td>
                  <button class="btn-edit-small" (click)="openEditAllergyModal(allergy)">Izmeni</button>
                  <button class="btn-delete-small" (click)="deleteAllergy(allergy.id, allergy.name)">Obri≈°i</button>
                </td>
              </tr>
              <tr *ngIf="allergies.length === 0">
                <td colspan="3" class="no-data">Nema alergija u sistemu</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Dodavanje Alergija Pacijentima -->
        <div class="patient-allergies-section">
          <div class="section-header">
            <h4>Dodaj Alergiju Pacijentu</h4>
          </div>

          <form [formGroup]="patientAllergyForm" (ngSubmit)="addPatientAllergy()" class="patient-allergy-form">
            <div class="form-row">
              <div class="form-group">
                <label for="patientSelect">Pacijent *</label>
                <select id="patientSelect" formControlName="patientId" (change)="onPatientSelected($event)">
                  <option value="">-- Izaberi pacijenta --</option>
                  <option *ngFor="let patient of (patients$ | async)" [value]="patient.id">
                    {{ patient.firstName }} {{ patient.lastName }}
                  </option>
                </select>
                <div class="error" *ngIf="patientAllergyForm.get('patientId')?.invalid && patientAllergyForm.get('patientId')?.touched">
                  Pacijent je obavezan
                </div>
              </div>

              <div class="form-group">
                <label for="allergySelect">Alergija *</label>
                <select id="allergySelect" formControlName="allergyId">
                  <option value="">-- Izaberi alergiju --</option>
                  <option *ngFor="let allergy of (allergies$ | async)" [value]="allergy.id">
                    {{ allergy.name }}
                  </option>
                </select>
                <div class="error" *ngIf="patientAllergyForm.get('allergyId')?.invalid && patientAllergyForm.get('allergyId')?.touched">
                  Alergija je obavezna
                </div>
              </div>

              <div class="form-group">
                <label for="diagnosedDate">Datum Dijagnoze</label>
                <input type="date" id="diagnosedDate" formControlName="diagnosedDate">
              </div>

              <div class="form-group-button">
                <button type="submit" class="btn-primary" [disabled]="patientAllergyForm.invalid || isAddingPatientAllergy">
                  {{ isAddingPatientAllergy ? 'Dodavanje...' : 'Dodaj' }}
                </button>
              </div>
            </div>
          </form>

          <!-- Lista alergija selektovanog pacijenta -->
          <div *ngIf="selectedPatientId" class="selected-patient-allergies">
            <h5>Alergije pacijenta: {{ selectedPatientName }}</h5>
            <div *ngIf="isLoadingPatientAllergies" class="loading">Uƒçitavanje...</div>
            <table class="patient-allergies-table" *ngIf="!isLoadingPatientAllergies && selectedPatientAllergies.length > 0">
              <thead>
                <tr>
                  <th>Alergija</th>
                  <th>Datum Dijagnoze</th>
                  <th>Akcije</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pa of selectedPatientAllergies">
                  <td>{{ pa.allergy?.name }}</td>
                  <td>{{ pa.diagnosedDate ? (pa.diagnosedDate | date:'dd.MM.yyyy') : 'N/A' }}</td>
                  <td>
                    <button class="btn-delete-small" (click)="removePatientAllergy(pa.id)">Ukloni</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <p *ngIf="!isLoadingPatientAllergies && selectedPatientAllergies.length === 0" class="no-data">
              Pacijent nema evidentirane alergije
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Profil Tab -->
    <div *ngIf="activeTab === 'profil'" class="tab-content">
      <div class="profile-header">
        <h3>Moj Profil</h3>
        <button 
          *ngIf="!isEditMode" 
          class="btn-edit" 
          (click)="toggleEditMode()">
           Izmeni Profil
        </button>
      </div>

      <!-- View Mode -->
      <div *ngIf="!isEditMode" class="profile-info">
        <div class="info-section">
          <h5>Liƒçni podaci</h5>
          <div class="info-row">
            <span class="label">Ime:</span>
            <span class="value">{{ currentUser.firstName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Prezime:</span>
            <span class="value">{{ currentUser.lastName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Email:</span>
            <span class="value">{{ currentUser.email }}</span>
          </div>
          <div class="info-row">
            <span class="label">Telefon:</span>
            <span class="value">{{ currentUser.phoneNumber || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Datum roƒëenja:</span>
            <span class="value">{{ currentUser.dateOfBirth || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Pol:</span>
            <span class="value">{{ currentUser.gender || 'Nije uneto' }}</span>
          </div>
        </div>

        <div class="info-section">
          <h5>Administratorski pristup</h5>
          <div class="info-row">
            <span class="label">Uloga:</span>
            <span class="value admin-role">Administrator</span>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditMode" class="edit-profile-form">
        <form [formGroup]="editProfileForm" (ngSubmit)="saveProfile()">
          <div class="form-section">
            <h5>Liƒçni podaci</h5>
            
            <div class="form-group">
              <label>Ime:</label>
              <input type="text" formControlName="firstName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('firstName')?.invalid && editProfileForm.get('firstName')?.touched">
                Ime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Prezime:</label>
              <input type="text" formControlName="lastName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('lastName')?.invalid && editProfileForm.get('lastName')?.touched">
                Prezime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Telefon:</label>
              <input type="text" formControlName="phoneNumber" class="form-control">
            </div>

            <div class="form-group">
              <label>Datum roƒëenja:</label>
              <input type="date" formControlName="dateOfBirth" class="form-control">
            </div>

            <div class="form-group">
              <label>Pol:</label>
              <select formControlName="gender" class="form-control">
                <option value="">Izaberi pol</option>
                <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-save" 
              [disabled]="editProfileForm.invalid || (isUpdating$ | async)">
              {{ (isUpdating$ | async) ? 'ƒåuvanje...' : ' Saƒçuvaj' }}
            </button>
            <button 
              type="button" 
              class="btn-cancel" 
              (click)="cancelEdit()"
              [disabled]="isUpdating$ | async">
               Otka≈æi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Pacijenti Tab -->
    <div *ngIf="activeTab === 'pacijenti'" class="tab-content">
      <h3>Upravljanje Pacijentima</h3>
      
      <!-- PatientListComponent sa @Input i @Output -->
      <app-patient-list
        [patients]="(patients$ | async) || []"
        [loading]="(isLoadingUsers$ | async) || false"
        (deletePatient)="handleDeletePatient($event)"
        (editPatient)="handleEditPatient($event)">
      </app-patient-list>
    </div>

    <!-- Doktori Tab -->
    <div *ngIf="activeTab === 'doktori'" class="tab-content">
      <div class="tab-header">
        <h3>Upravljanje Doktorima</h3>
        <button class="btn-add-doctor" (click)="toggleAddDoctorForm()">
          {{ showAddDoctorForm ? ' Zatvori' : ' Dodaj Doktora' }}
        </button>
      </div>

      <!-- Add Doctor Form Component -->
      <app-add-doctor-form
        *ngIf="showAddDoctorForm"
        (submitForm)="handleSubmitDoctorForm($event)"
        (cancel)="handleCancelDoctorForm()">
      </app-add-doctor-form>

      <!-- Doctor List Component -->
      <app-doctor-list
        [doctors]="(doctors$ | async) || []"
        [loading]="(isLoadingUsers$ | async) || false"
        [expandedDoctorId]="expandedDoctorId"
        [selectedDoctorAction]="selectedDoctorAction"
        [selectedDoctorId]="selectedDoctorId"
        [doctorPatients]="doctorPatients"
        [loadingDoctorPatients]="loadingDoctorPatients"
        [doctorSchedules]="doctorSchedules"
        [loadingDoctorSchedules]="loadingDoctorSchedules"
        [selectedMonth]="selectedMonth"
        [scheduleSuccessMessage]="scheduleSuccessMessage"
        [scheduleErrorMessage]="scheduleErrorMessage"
        (deleteDoctor)="handleDeleteDoctor($event)"
        (editDoctor)="handleEditDoctor($event)"
        (toggleDetails)="toggleDoctorDetails($event)"
        (viewPatients)="viewDoctorPatients($event)"
        (addSchedule)="openAddScheduleForm($event)"
        (viewSchedule)="viewDoctorSchedule($event)"
        (submitSchedule)="handleSubmitSchedule($event)"
        (closeScheduleForm)="closeScheduleForm()"
        (monthChange)="onMonthChange($event)">
      </app-doctor-list>
    </div>

    <!-- Administratori Tab -->
    <div *ngIf="activeTab === 'administratori'" class="tab-content">
      <div class="tab-header">
        <h3>Upravljanje Administratorima</h3>
        <button class="btn-add-admin" (click)="toggleAddAdminForm()">
          {{ showAddAdminForm ? ' Zatvori' : ' Dodaj Administratora' }}
        </button>
      </div>

      <!-- Add Admin Form Component -->
      <app-add-admin-form
        *ngIf="showAddAdminForm"
        (submitForm)="handleSubmitAdminForm($event)"
        (cancel)="handleCancelAdminForm()">
      </app-add-admin-form>

      <!-- Admin List Component -->
      <app-admin-list
        [admins]="(admins$ | async) || []"
        [loading]="(isLoadingUsers$ | async) || false"
        (deleteAdmin)="handleDeleteAdmin($event)"
        (editAdmin)="handleEditAdmin($event)">
      </app-admin-list>
    </div>

    <!-- Tipovi Pregleda Tab -->
    <div *ngIf="activeTab === 'tipovi-pregleda'" class="tab-content">
      <h3>Upravljanje Tipovima Pregleda</h3>
      
      <div class="section-header">
        <button class="btn-add" (click)="openAddAppointmentTypeModal()">+ Dodaj Tip Pregleda</button>
      </div>

      <div *ngIf="isLoadingAppointmentTypes$ | async" class="loading">Uƒçitavanje tipova pregleda...</div>
      <div *ngIf="appointmentTypesError$ | async as error" class="error-message">{{ error }}</div>

      <table class="appointment-types-table" *ngIf="(appointmentTypes$ | async) as appointmentTypes">
        <thead>
          <tr>
            <th>Naziv</th>
            <th>Specijalizacija</th>
            <th>Cena (RSD)</th>
            <th>Trajanje (min)</th>
            <th>Status</th>
            <th>Akcije</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let type of appointmentTypes">
            <td>{{ type.name }}</td>
            <td>{{ type.specialization }}</td>
            <td>{{ type.price | number:'1.0-0' }}</td>
            <td>{{ type.durationMinutes }}</td>
            <td>
              <span class="status-badge" [class.active]="type.isActive" [class.inactive]="!type.isActive">
                {{ type.isActive ? 'Aktivan' : 'Neaktivan' }}
              </span>
            </td>
            <td>
              <button class="btn-edit-small" (click)="openEditAppointmentTypeModal(type)">Izmeni</button>
              <button 
                class="btn-delete-small" 
                *ngIf="type.isActive"
                (click)="deactivateAppointmentType(type.id, type.name)">
                Deaktiviraj
              </button>
              <button 
                class="btn-activate-small" 
                *ngIf="!type.isActive"
                (click)="activateAppointmentType(type.id, type.name)">
                Aktiviraj
              </button>
            </td>
          </tr>
          <tr *ngIf="appointmentTypes.length === 0">
            <td colspan="6" class="no-data">Nema tipova pregleda u sistemu</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pove≈æi Tab -->
    <div *ngIf="activeTab === 'povezi'" class="tab-content">
      <h3> Pove≈æi doktora i pacijenta</h3>
      <p style="color: #64748b; margin-bottom: 2rem; text-align: center;">
        Izaberi pacijenta i doktora da bi ih povezao u sistem
      </p>
      
      <div class="assign-form">
        <!-- Pacijent Autocomplete -->
        <div class="form-group autocomplete-container">
          <label> Pacijent</label>
          
          <!-- Izabrani pacijent -->
          <div *ngIf="selectedPatient" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>{{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</strong>
                <span>{{ selectedPatient.email }}</span>
              </div>
              <button class="btn-clear" (click)="clearPatient()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedPatient">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email pacijenta..."
              (input)="onPatientSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showPatientDropdown && (filteredPatients$ | async) as patients">
              <div 
                *ngFor="let patient of patients" 
                class="autocomplete-item"
                (mousedown)="selectPatient(patient)">
                <div class="user-icon"></div>
                <div class="user-details">
                  <strong>{{ patient.firstName }} {{ patient.lastName }}</strong>
                  <span>{{ patient.email }}</span>
                </div>
              </div>
              <div *ngIf="patients.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Doktor Autocomplete -->
        <div class="form-group autocomplete-container">
          <label> Doktor</label>
          
          <!-- Izabrani doktor -->
          <div *ngIf="selectedDoctor" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>Dr. {{ selectedDoctor.firstName }} {{ selectedDoctor.lastName }}</strong>
                <span>{{ selectedDoctor.email }}</span>
                <span class="specialization" *ngIf="selectedDoctor.specialization">
                  {{ selectedDoctor.specialization }}
                </span>
              </div>
              <button class="btn-clear" (click)="clearDoctor()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedDoctor">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email doktora..."
              (input)="onDoctorSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showDoctorDropdown && (filteredDoctors$ | async) as doctors">
              <div 
                *ngFor="let doctor of doctors" 
                class="autocomplete-item"
                (mousedown)="selectDoctor(doctor)">
                <div class="user-icon"></div>
                <div class="user-details">
                  <strong>Dr. {{ doctor.firstName }} {{ doctor.lastName }}</strong>
                  <span>{{ doctor.email }}</span>
                  <span class="spec" *ngIf="doctor.specialization">{{ doctor.specialization }}</span>
                </div>
              </div>
              <div *ngIf="doctors.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button 
            class="btn-assign"
            [disabled]="!selectedPatient || !selectedDoctor"
            (click)="assignDoctorToPatient()">
             Dodeli doktora pacijentu
          </button>
        </div>
      </div>
    </div>

    <!-- Ukloni Tab -->
    <div *ngIf="activeTab === 'ukloni'" class="tab-content">
      <h3> Ukloni Pacijenta Doktoru</h3>
      <p style="color: #64748b; margin-bottom: 2rem; text-align: center;">
        Prvo izaberi doktora, pa onda pacijenta koji treba da se ukloni
      </p>
      
      <div class="assign-form">
        <!-- Doktor Autocomplete -->
        <div class="form-group autocomplete-container">
          <label> Doktor</label>
          
          <!-- Izabrani doktor -->
          <div *ngIf="selectedRemoveDoctor" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>Dr. {{ selectedRemoveDoctor.firstName }} {{ selectedRemoveDoctor.lastName }}</strong>
                <span>{{ selectedRemoveDoctor.email }}</span>
                <span class="specialization" *ngIf="selectedRemoveDoctor.specialization">
                  {{ selectedRemoveDoctor.specialization }}
                </span>
              </div>
              <button class="btn-clear" (click)="clearRemoveDoctor()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedRemoveDoctor">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email doktora..."
              (input)="onRemoveDoctorSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showRemoveDoctorDropdown && (filteredRemoveDoctors$ | async) as doctors">
              <div 
                *ngFor="let doctor of doctors" 
                class="autocomplete-item"
                (mousedown)="selectRemoveDoctor(doctor)">
                <div class="user-icon"></div>
                <div class="user-details">
                  <strong>Dr. {{ doctor.firstName }} {{ doctor.lastName }}</strong>
                  <span>{{ doctor.email }}</span>
                  <span class="spec" *ngIf="doctor.specialization">{{ doctor.specialization }}</span>
                </div>
              </div>
              <div *ngIf="doctors.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Pacijent Autocomplete - prikazuje se samo ako je doktor izabran -->
        <div class="form-group autocomplete-container" *ngIf="selectedRemoveDoctor">
          <label> Pacijent</label>
          
          <!-- Izabrani pacijent -->
          <div *ngIf="selectedRemovePatient" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>{{ selectedRemovePatient.firstName }} {{ selectedRemovePatient.lastName }}</strong>
                <span>{{ selectedRemovePatient.email }}</span>
              </div>
              <button class="btn-clear" (click)="clearRemovePatient()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedRemovePatient">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email pacijenta..."
              (input)="onRemovePatientSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showRemovePatientDropdown && (filteredRemovePatients$ | async) as patients">
              <div 
                *ngFor="let patient of patients" 
                class="autocomplete-item"
                (mousedown)="selectRemovePatient(patient)">
                <div class="user-icon"></div>
                <div class="user-details">
                  <strong>{{ patient.firstName }} {{ patient.lastName }}</strong>
                  <span>{{ patient.email }}</span>
                </div>
              </div>
              <div *ngIf="patients.length === 0" class="no-results">
                Nema pacijenata za ovog doktora
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions" *ngIf="selectedRemoveDoctor">
          <button 
            class="btn-remove"
            [disabled]="!selectedRemovePatient || !selectedRemoveDoctor"
            (click)="removePatientFromDoctor()">
             Ukloni Pacijenta od Doktora
          </button>
        </div>
      </div>
    </div>

    <!-- Blok Termini Tab -->
    <div *ngIf="activeTab === 'blok-termini'" class="tab-content">
      <div class="section-header">
        <h3>Blok Termini (Operacije)</h3>
        <p class="section-description">
          Kreirajte blok termin za operacije i du≈æe zahvate.
        </p>
        <button class="btn-add-block" (click)="openBlockAppointmentModal()">
          Kreiraj Blok Termin
        </button>
      </div>
    </div>

    <!-- Svi Termini Tab -->
    <div *ngIf="activeTab === 'termini'" class="tab-content">
      <div class="section-header">
        <h3> Svi Termini</h3>
        <p class="section-description">
          Pregled svih termina sa moguƒáno≈°ƒáu filtriranja po datumu, doktoru i pacijentu.
        </p>
      </div>

      <!-- Filter Form - REACTIVE sa combineLatest -->
      <div class="filter-container">
        <div class="filter-row">
          <div class="filter-field">
            <label for="filterDateFrom">Datum od</label>
            <input 
              type="date" 
              id="filterDateFrom" 
              [(ngModel)]="appointmentDateFromFilter">
          </div>

          <div class="filter-field">
            <label for="filterDateTo">Datum do</label>
            <input 
              type="date" 
              id="filterDateTo" 
              [(ngModel)]="appointmentDateToFilter">
          </div>

          <div class="filter-field">
            <label for="filterDoctor">Doktor</label>
            <select id="filterDoctor" [(ngModel)]="appointmentDoctorFilter">
              <option value="">-- Svi doktori --</option>
              <option *ngFor="let doctor of allDoctorsForBlock$ | async" [value]="doctor.id">
                Dr. {{ doctor.firstName }} {{ doctor.lastName }}
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label for="filterPatient">Pacijent</label>
            <select id="filterPatient" [(ngModel)]="appointmentPatientFilter">
              <option value="">-- Svi pacijenti --</option>
              <option *ngFor="let patient of allPatientsForBlock$ | async" [value]="patient.id">
                {{ patient.firstName }} {{ patient.lastName }}
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label for="filterStatus">Status</label>
            <select id="filterStatus" [(ngModel)]="appointmentStatusFilter">
              <option value="">-- Svi statusi --</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>

          <div class="filter-actions">
            <button 
              class="btn-clear-filter" 
              (click)="resetAppointmentFilters()">
               Resetuj filtere
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingAllAppointments" class="loading-state">
         Uƒçitavanje termina...
      </div>

      <!-- Appointments List - REACTIVE sa async pipe -->
      <ng-container *ngIf="!isLoadingAllAppointments && (filteredAppointments$ | async) as filteredAppointments">
        <div *ngIf="filteredAppointments.length === 0" class="empty-state">
           Nema termina prema zadatim filterima
        </div>

        <div *ngIf="filteredAppointments.length > 0" class="appointments-grid">
          <div class="appointment-card" 
               *ngFor="let appointment of filteredAppointments"
               [ngClass]="{'block-appointment-card': appointment.isBlockAppointment}">
          
          <div class="appointment-header">
            <span class="appointment-date"> {{ appointment.date | date:'dd.MM.yyyy' }}</span>
            <span class="appointment-time">
               {{ appointment.startTime }}
              <span *ngIf="appointment.isBlockAppointment"> - {{ appointment.endTime }}</span>
            </span>
            <span class="appointment-status" [ngClass]="'status-' + appointment.status.toLowerCase()">
              {{ appointment.status }}
            </span>
          </div>

          <!-- Block Appointment Badge -->
          <div *ngIf="appointment.isBlockAppointment" class="block-badge">
             BLOK TERMIN - {{ appointment.duration }} min ({{ appointment.blockSize }} slotova)
          </div>
          
          <div class="appointment-body">
            <div class="appointment-field">
              <strong> Doktor:</strong> 
              Dr. {{ appointment.doctor?.firstName }} {{ appointment.doctor?.lastName }}
            </div>
            
            <div class="appointment-field">
              <strong> Pacijent:</strong> 
              <span *ngIf="appointment.patient">
                {{ appointment.patient.firstName }} {{ appointment.patient.lastName }}
              </span>
              <span *ngIf="!appointment.patient" class="text-muted">Nije dodeljen</span>
            </div>
            
            <div class="appointment-field">
              <strong> Razlog:</strong> 
              {{ appointment.reason }}
            </div>
            
            <div class="appointment-field" *ngIf="appointment.appointmentType">
              <strong>üìã Tip pregleda:</strong> 
              <span class="appointment-type-badge">
                {{ appointment.appointmentType.name }} ({{ appointment.appointmentType.price }} RSD, {{ appointment.appointmentType.durationMinutes }} min)
              </span>
            </div>
            
            <div class="appointment-field" *ngIf="appointment.notes">
              <strong> Napomena:</strong> 
              {{ appointment.notes }}
            </div>
          </div>
        </div>
        </div>

        <!-- Results Counter - sa REDUCE operatorom -->
        <div class="results-counter">
           Prikazano termina: 
          <strong>{{ filteredAppointments.length }}</strong> 
          od 
          <strong>{{ totalAppointmentsCount$ | async }}</strong>
          <span class="counter-note"></span>
        </div>

        <!-- Statistika sa REDUCE operatorom -->
        <div class="stats-container" *ngIf="(appointmentStats$ | async) as stats">
          <h4> Statistika po statusu:</h4>
          <div class="stats-grid">
            <div class="stat-card" *ngFor="let stat of stats">
              <div class="stat-status">{{ stat.status }}</div>
              <div class="stat-count">{{ stat.count }} termina</div>
              <div class="stat-percentage">{{ stat.percentage }}%</div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Block Appointment Modal -->
  <div *ngIf="showBlockAppointmentModal" class="modal-overlay" (click)="closeBlockAppointmentModal()">
    <div class="modal-content block-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3> Kreiraj Blok Termin</h3>
        <button class="btn-close" (click)="closeBlockAppointmentModal()">‚úï</button>
      </div>
      
      <form [formGroup]="blockAppointmentForm" (ngSubmit)="submitBlockAppointment()" class="modal-body">
        <!-- Doctor Selection -->
        <div class="form-group">
          <label for="blockDoctorId">Izaberi doktora *</label>
          <select id="blockDoctorId" formControlName="doctorId" required>
            <option value="">-- Izaberi doktora --</option>
            <option *ngFor="let doctor of allDoctorsForBlock$ | async" [value]="doctor.id">
              Dr. {{ doctor.firstName }} {{ doctor.lastName }} - {{ doctor.specialization }}
            </option>
          </select>
        </div>

        <!-- Patient Selection (Optional) -->
        <div class="form-group">
          <label for="blockPatientId">Izaberi pacijenta</label>
          <select id="blockPatientId" formControlName="patientId">
            <option value="">-- Izaberi pacijenta --</option>
            <option *ngFor="let patient of allPatientsForBlock$ | async" [value]="patient.id">
              {{ patient.firstName }} {{ patient.lastName }}
            </option>
          </select>
        </div>

        <!-- Date -->
        <div class="form-group">
          <label for="blockDate">Datum *</label>
          <input type="date" id="blockDate" formControlName="date" required>
        </div>

        <!-- Start Time -->
        <div class="form-group">
          <label for="blockStartTime">Poƒçetno vreme *</label>
          <div *ngIf="isLoadingStartTimes" class="loading-slots">
             Uƒçitavanje slobodnih slotova...
          </div>
          <select 
            *ngIf="!isLoadingStartTimes" 
            id="blockStartTime" 
            formControlName="startTime" 
            required>
            <option value="">-- Izaberi poƒçetno vreme --</option>
            <option *ngFor="let slot of availableStartTimes" [value]="slot">
              {{ slot }}
            </option>
          </select>
          <small class="field-hint" *ngIf="availableStartTimes.length > 0">
            Prvi slot blok termina - dostupno {{ availableStartTimes.length }} slobodnih slotova
          </small>
          <small class="field-hint field-warning" *ngIf="availableStartTimes.length === 0 && !isLoadingStartTimes && blockAppointmentForm.get('doctorId')?.value && blockAppointmentForm.get('date')?.value">
             Nema slobodnih slotova za izabrani datum
          </small>
        </div>

        <!-- Number of Slots -->
        <div class="form-group">
          <label for="blockSlots">Broj slotova *</label>
          <input 
            type="number" 
            id="blockSlots" 
            formControlName="numberOfSlots" 
            min="1" 
            max="16" 
            required>
          <small class="field-hint">
            1 slot = 30 minuta 
          </small>
        </div>

        <!-- Reason -->
        <div class="form-group">
          <label for="blockReason">Razlog/Tip *</label>
          <input 
            type="text" 
            id="blockReason" 
            formControlName="reason" 
            placeholder="npr. OPERACIJA, HIRURGIJA..."
            required>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="blockNotes">Napomena</label>
          <textarea 
            id="blockNotes" 
            formControlName="notes" 
            rows="3" 
            placeholder="Dodatne napomene..."></textarea>
        </div>

        <!-- Submit -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="closeBlockAppointmentModal()"
            [disabled]="isSubmittingBlockAppointment">
            Otka≈æi
          </button>
          <button 
            type="submit" 
            class="btn-submit" 
            [disabled]="blockAppointmentForm.invalid || isSubmittingBlockAppointment">
            <span *ngIf="!isSubmittingBlockAppointment"> Kreiraj Blok Termin</span>
            <span *ngIf="isSubmittingBlockAppointment"> Kreiranje...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal Component -->
  <app-edit-user-modal
    [user]="selectedUserForEdit"
    [show]="showEditModal"
    (save)="handleSaveUser($event)"
    (close)="handleCloseEditModal()">
  </app-edit-user-modal>

  <!-- Allergy Modal (Add/Edit) -->
  <div *ngIf="showAllergyModal" class="modal-overlay" (click)="closeAllergyModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ allergyModalMode === 'add' ? 'Dodaj Novu Alergiju' : 'Izmeni Alergiju' }}</h3>
        <button class="btn-close" (click)="closeAllergyModal()">‚úï</button>
      </div>
      
      <form [formGroup]="allergyForm" (ngSubmit)="submitAllergyForm()" class="modal-body">
        <div class="form-group">
          <label for="allergyName">Naziv Alergije *</label>
          <input 
            type="text" 
            id="allergyName" 
            formControlName="name"
            placeholder="Npr: Penicilin, Kikiriki, Polen...">
          <div class="error" *ngIf="allergyForm.get('name')?.invalid && allergyForm.get('name')?.touched">
            Naziv alergije je obavezan (min 2 karaktera)
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeAllergyModal()">Otka≈æi</button>
          <button type="submit" class="btn-save" [disabled]="allergyForm.invalid || isSubmittingAllergy">
            {{ isSubmittingAllergy ? 'ƒåuvanje...' : 'Saƒçuvaj' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- AppointmentType Modal (Add/Edit) -->
  <div *ngIf="showAppointmentTypeModal" class="modal-overlay" (click)="closeAppointmentTypeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ appointmentTypeModalMode === 'add' ? 'Dodaj Novi Tip Pregleda' : 'Izmeni Tip Pregleda' }}</h3>
        <button class="btn-close" (click)="closeAppointmentTypeModal()">‚úï</button>
      </div>
      
      <form [formGroup]="appointmentTypeForm" (ngSubmit)="submitAppointmentTypeForm()" class="modal-body">
        <div class="form-group">
          <label for="appointmentTypeName">Naziv Tipa Pregleda *</label>
          <input 
            type="text" 
            id="appointmentTypeName" 
            formControlName="name"
            placeholder="Npr: Kontrolni pregled, EKG, Ultrazvuk...">
          <div class="error" *ngIf="appointmentTypeForm.get('name')?.invalid && appointmentTypeForm.get('name')?.touched">
            Naziv je obavezan
          </div>
        </div>

        <div class="form-group">
          <label for="appointmentTypeDescription">Opis</label>
          <textarea 
            id="appointmentTypeDescription" 
            formControlName="description"
            rows="3"
            placeholder="Detaljan opis pregleda..."></textarea>
        </div>

        <div class="form-group">
          <label for="appointmentTypeSpecialization">Specijalizacija *</label>
          <select id="appointmentTypeSpecialization" formControlName="specialization">
            <option value="">-- Izaberi specijalizaciju --</option>
            <option *ngFor="let spec of specializations" [value]="spec">{{ spec }}</option>
          </select>
          <div class="error" *ngIf="appointmentTypeForm.get('specialization')?.invalid && appointmentTypeForm.get('specialization')?.touched">
            Specijalizacija je obavezna
          </div>
        </div>

        <div class="form-group">
          <label for="appointmentTypePrice">Cena (RSD) *</label>
          <input 
            type="number" 
            id="appointmentTypePrice" 
            formControlName="price"
            placeholder="2500"
            min="0">
          <div class="error" *ngIf="appointmentTypeForm.get('price')?.invalid && appointmentTypeForm.get('price')?.touched">
            Cena mora biti pozitivan broj
          </div>
        </div>

        <div class="form-group">
          <label for="appointmentTypeDuration">Trajanje (minuta) *</label>
          <select id="appointmentTypeDuration" formControlName="durationMinutes">
            <option [value]="30">30 minuta</option>
            <option [value]="60">60 minuta</option>
          </select>
          <div class="error" *ngIf="appointmentTypeForm.get('durationMinutes')?.invalid && appointmentTypeForm.get('durationMinutes')?.touched">
            Trajanje je obavezno
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeAppointmentTypeModal()">Otka≈æi</button>
          <button type="submit" class="btn-save" [disabled]="appointmentTypeForm.invalid || isSubmittingAppointmentType">
            {{ isSubmittingAppointmentType ? 'ƒåuvanje...' : 'Saƒçuvaj' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
