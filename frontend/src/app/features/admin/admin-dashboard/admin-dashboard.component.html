<div class="dashboard-container" *ngIf="currentUser$ | async as currentUser">
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <h2>MediSync - Admin Panel</h2>
    </div>
    <div class="user-info">
      <span>Dobrodo≈°li, {{ currentUser.firstName }} {{ currentUser.lastName }}</span>
      <button class="btn-logout" (click)="logout()">Odjavi se</button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'profil'" 
      (click)="selectTab('profil')">
      üë§ Profil
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'pacijenti'" 
      (click)="selectTab('pacijenti')">
      üè• Pacijenti
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'doktori'" 
      (click)="selectTab('doktori')">
      üë®‚Äç‚öïÔ∏è Doktori
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'administratori'" 
      (click)="selectTab('administratori')">
      üëî Administratori
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'povezi'" 
      (click)="selectTab('povezi')">
      üîó Pove≈æi doktora i pacijenta
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'ukloni'" 
      (click)="selectTab('ukloni')">
      ‚ùå Ukloni pacijenta doktoru
    </button>
  </nav>

  <!-- Content Area -->
  <div class="content">
    <!-- Profil Tab -->
    <div *ngIf="activeTab === 'profil'" class="tab-content">
      <div class="profile-header">
        <h3>Moj Profil</h3>
        <button 
          *ngIf="!isEditMode" 
          class="btn-edit" 
          (click)="toggleEditMode()">
          ‚úèÔ∏è Izmeni Profil
        </button>
      </div>

      <!-- View Mode -->
      <div *ngIf="!isEditMode" class="profile-info">
        <div class="info-section">
          <h5>Liƒçni podaci</h5>
          <div class="info-row">
            <span class="label">Ime:</span>
            <span class="value">{{ currentUser.firstName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Prezime:</span>
            <span class="value">{{ currentUser.lastName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Email:</span>
            <span class="value">{{ currentUser.email }}</span>
          </div>
          <div class="info-row">
            <span class="label">Telefon:</span>
            <span class="value">{{ currentUser.phoneNumber || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Datum roƒëenja:</span>
            <span class="value">{{ currentUser.dateOfBirth || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Pol:</span>
            <span class="value">{{ currentUser.gender || 'Nije uneto' }}</span>
          </div>
        </div>

        <div class="info-section">
          <h5>Administratorski pristup</h5>
          <div class="info-row">
            <span class="label">Uloga:</span>
            <span class="value admin-role">Administrator</span>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditMode" class="edit-profile-form">
        <form [formGroup]="editProfileForm" (ngSubmit)="saveProfile()">
          <div class="form-section">
            <h5>Liƒçni podaci</h5>
            
            <div class="form-group">
              <label>Ime:</label>
              <input type="text" formControlName="firstName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('firstName')?.invalid && editProfileForm.get('firstName')?.touched">
                Ime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Prezime:</label>
              <input type="text" formControlName="lastName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('lastName')?.invalid && editProfileForm.get('lastName')?.touched">
                Prezime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Telefon:</label>
              <input type="text" formControlName="phoneNumber" class="form-control">
            </div>

            <div class="form-group">
              <label>Datum roƒëenja:</label>
              <input type="date" formControlName="dateOfBirth" class="form-control">
            </div>

            <div class="form-group">
              <label>Pol:</label>
              <select formControlName="gender" class="form-control">
                <option value="">Izaberi pol</option>
                <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-save" 
              [disabled]="editProfileForm.invalid || (isUpdating$ | async)">
              {{ (isUpdating$ | async) ? 'ƒåuvanje...' : 'üíæ Saƒçuvaj' }}
            </button>
            <button 
              type="button" 
              class="btn-cancel" 
              (click)="cancelEdit()"
              [disabled]="isUpdating$ | async">
              ‚ùå Otka≈æi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Pacijenti Tab -->
    <div *ngIf="activeTab === 'pacijenti'" class="tab-content">
      <h3>Upravljanje Pacijentima</h3>
      
      <!-- Loading state -->
      <div *ngIf="isLoadingUsers$ | async" class="loading">
        <p>Uƒçitavanje pacijenata...</p>
      </div>

      <!-- Empty state -->
      <div *ngIf="!(isLoadingUsers$ | async) && (patients$ | async)?.length === 0" class="empty-state">
        <p>Nema registrovanih pacijenata.</p>
      </div>

      <!-- Patients Table -->
      <div *ngIf="!(isLoadingUsers$ | async) && (patients$ | async)?.length! > 0" class="patients-table-container">
        <table class="patients-table">
          <thead>
            <tr>
              <th>Ime i Prezime</th>
              <th>Email</th>
              <th>Telefon</th>
              <th>Datum roƒëenja</th>
              <th>Pol</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let patient of patients$ | async">
              <td>{{ patient.firstName }} {{ patient.lastName }}</td>
              <td>{{ patient.email }}</td>
              <td>{{ patient.phoneNumber || 'Nije uneto' }}</td>
              <td>{{ patient.dateOfBirth || 'Nije uneto' }}</td>
              <td>{{ patient.gender || 'Nije uneto' }}</td>
              <td class="actions">
                <button class="btn-edit" (click)="openEditModal(patient)" title="Izmeni pacijenta">
                  ‚úèÔ∏è Izmeni
                </button>
                <button class="btn-delete" (click)="deletePatient(patient.id)" title="Obri≈°i pacijenta">
                  üóëÔ∏è Obri≈°i
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Doktori Tab -->
    <div *ngIf="activeTab === 'doktori'" class="tab-content">
      <div class="tab-header">
        <h3>Upravljanje Doktorima</h3>
        <button class="btn-add-doctor" (click)="toggleAddDoctorForm()">
          {{ showAddDoctorForm ? '‚ùå Zatvori' : '‚ûï Dodaj Doktora' }}
        </button>
      </div>

      <!-- Add Doctor Form -->
      <div *ngIf="showAddDoctorForm" class="add-doctor-form">
        <h4>‚ûï Kreiranje Novog Doktora</h4>
        <form [formGroup]="addDoctorForm" (ngSubmit)="createDoctor()">
          <div class="form-row">
            <div class="form-group">
              <label>Ime *</label>
              <input type="text" formControlName="firstName" class="form-control" placeholder="Unesite ime">
              <div class="error" *ngIf="addDoctorForm.get('firstName')?.invalid && addDoctorForm.get('firstName')?.touched">
                Ime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Prezime *</label>
              <input type="text" formControlName="lastName" class="form-control" placeholder="Unesite prezime">
              <div class="error" *ngIf="addDoctorForm.get('lastName')?.invalid && addDoctorForm.get('lastName')?.touched">
                Prezime je obavezno
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" class="form-control" placeholder="email@example.com">
              <div class="error" *ngIf="addDoctorForm.get('email')?.invalid && addDoctorForm.get('email')?.touched">
                Email je obavezan i mora biti validan
              </div>
            </div>

            <div class="form-group">
              <label>Lozinka *</label>
              <input type="password" formControlName="password" class="form-control" placeholder="Minimum 6 karaktera">
              <div class="error" *ngIf="addDoctorForm.get('password')?.invalid && addDoctorForm.get('password')?.touched">
                Lozinka je obavezna (min 6 karaktera)
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Specijalizacija *</label>
              <input type="text" formControlName="specialization" class="form-control" placeholder="Kardiolog, Neurolog...">
              <div class="error" *ngIf="addDoctorForm.get('specialization')?.invalid && addDoctorForm.get('specialization')?.touched">
                Specijalizacija je obavezna
              </div>
            </div>

            <div class="form-group">
              <label>Telefon</label>
              <input type="text" formControlName="phoneNumber" class="form-control" placeholder="0601234567">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Datum roƒëenja</label>
              <input type="date" formControlName="dateOfBirth" class="form-control">
            </div>

            <div class="form-group">
              <label>Pol</label>
              <select formControlName="gender" class="form-control">
                <option value="">Izaberi pol</option>
                <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit" [disabled]="addDoctorForm.invalid || isCreatingDoctor">
              {{ isCreatingDoctor ? 'Kreiranje...' : '‚úÖ Kreiraj Doktora' }}
            </button>
            <button type="button" class="btn-cancel" (click)="toggleAddDoctorForm()" [disabled]="isCreatingDoctor">
              ‚ùå Otka≈æi
            </button>
          </div>
        </form>
      </div>
      
      <!-- Loading state -->
      <div *ngIf="isLoadingUsers$ | async" class="loading">
        <p>Uƒçitavanje doktora...</p>
      </div>

      <!-- Empty state -->
      <div *ngIf="!(isLoadingUsers$ | async) && (doctors$ | async)?.length === 0" class="empty-state">
        <p>Nema registrovanih doktora.</p>
      </div>

      <!-- Doctors Table -->
      <div *ngIf="!(isLoadingUsers$ | async) && (doctors$ | async)?.length! > 0" class="patients-table-container">
        <table class="patients-table">
          <thead>
            <tr>
              <th>Ime i Prezime</th>
              <th>Email</th>
              <th>Specijalizacija</th>
              <th>Telefon</th>
              <th>Datum roƒëenja</th>
              <th>Pol</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doctor of doctors$ | async">
              <td>{{ doctor.firstName }} {{ doctor.lastName }}</td>
              <td>{{ doctor.email }}</td>
              <td>{{ doctor.specialization || 'Nije uneto' }}</td>
              <td>{{ doctor.phoneNumber || 'Nije uneto' }}</td>
              <td>{{ doctor.dateOfBirth || 'Nije uneto' }}</td>
              <td>{{ doctor.gender || 'Nije uneto' }}</td>
              <td class="actions">
                <button class="btn-edit" (click)="openEditModal(doctor)" title="Izmeni doktora">
                  ‚úèÔ∏è Izmeni
                </button>
                <button class="btn-delete" (click)="deleteDoctor(doctor.id)" title="Obri≈°i doktora">
                  üóëÔ∏è Obri≈°i
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Administratori Tab -->
    <div *ngIf="activeTab === 'administratori'" class="tab-content">
      <h3>Upravljanje Administratorima</h3>
      
      <!-- Loading state -->
      <div *ngIf="isLoadingUsers$ | async" class="loading">
        <p>Uƒçitavanje administratora...</p>
      </div>

      <!-- Empty state -->
      <div *ngIf="!(isLoadingUsers$ | async) && (admins$ | async)?.length === 0" class="empty-state">
        <p>Nema registrovanih administratora.</p>
      </div>

      <!-- Admins Table -->
      <div *ngIf="!(isLoadingUsers$ | async) && (admins$ | async)?.length! > 0" class="patients-table-container">
        <table class="patients-table">
          <thead>
            <tr>
              <th>Ime i Prezime</th>
              <th>Email</th>
              <th>Telefon</th>
              <th>Datum roƒëenja</th>
              <th>Pol</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let admin of admins$ | async">
              <td>{{ admin.firstName }} {{ admin.lastName }}</td>
              <td>{{ admin.email }}</td>
              <td>{{ admin.phoneNumber || 'Nije uneto' }}</td>
              <td>{{ admin.dateOfBirth || 'Nije uneto' }}</td>
              <td>{{ admin.gender || 'Nije uneto' }}</td>
              <td class="actions">
                <button class="btn-edit" (click)="openEditModal(admin)" title="Izmeni administratora">
                  ‚úèÔ∏è Izmeni
                </button>
                <button class="btn-delete" (click)="deleteAdmin(admin.id)" title="Obri≈°i administratora">
                  üóëÔ∏è Obri≈°i
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pove≈æi Tab -->
    <div *ngIf="activeTab === 'povezi'" class="tab-content">
      <h3>üîó Pove≈æi doktora i pacijenta</h3>
      <p style="color: #64748b; margin-bottom: 2rem; text-align: center;">
        Izaberi pacijenta i doktora da bi ih povezao u sistem
      </p>
      
      <div class="assign-form">
        <!-- Pacijent Autocomplete -->
        <div class="form-group autocomplete-container">
          <label>üë§ Pacijent</label>
          
          <!-- Izabrani pacijent -->
          <div *ngIf="selectedPatient" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>{{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</strong>
                <span>{{ selectedPatient.email }}</span>
              </div>
              <button class="btn-clear" (click)="clearPatient()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedPatient">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email pacijenta..."
              (input)="onPatientSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showPatientDropdown && (filteredPatients$ | async) as patients">
              <div 
                *ngFor="let patient of patients" 
                class="autocomplete-item"
                (mousedown)="selectPatient(patient)">
                <div class="user-icon">üë§</div>
                <div class="user-details">
                  <strong>{{ patient.firstName }} {{ patient.lastName }}</strong>
                  <span>{{ patient.email }}</span>
                </div>
              </div>
              <div *ngIf="patients.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Doktor Autocomplete -->
        <div class="form-group autocomplete-container">
          <label>üë®‚Äç‚öïÔ∏è Doktor</label>
          
          <!-- Izabrani doktor -->
          <div *ngIf="selectedDoctor" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>Dr. {{ selectedDoctor.firstName }} {{ selectedDoctor.lastName }}</strong>
                <span>{{ selectedDoctor.email }}</span>
                <span class="specialization" *ngIf="selectedDoctor.specialization">
                  {{ selectedDoctor.specialization }}
                </span>
              </div>
              <button class="btn-clear" (click)="clearDoctor()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedDoctor">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email doktora..."
              (input)="onDoctorSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showDoctorDropdown && (filteredDoctors$ | async) as doctors">
              <div 
                *ngFor="let doctor of doctors" 
                class="autocomplete-item"
                (mousedown)="selectDoctor(doctor)">
                <div class="user-icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="user-details">
                  <strong>Dr. {{ doctor.firstName }} {{ doctor.lastName }}</strong>
                  <span>{{ doctor.email }}</span>
                  <span class="spec" *ngIf="doctor.specialization">{{ doctor.specialization }}</span>
                </div>
              </div>
              <div *ngIf="doctors.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button 
            class="btn-assign"
            [disabled]="!selectedPatient || !selectedDoctor"
            (click)="assignDoctorToPatient()">
            üîó Dodeli doktora pacijentu
          </button>
        </div>
      </div>
    </div>

    <!-- Ukloni Tab -->
    <div *ngIf="activeTab === 'ukloni'" class="tab-content">
      <h3>‚ùå Ukloni Pacijenta Doktoru</h3>
      <p style="color: #64748b; margin-bottom: 2rem; text-align: center;">
        Prvo izaberi doktora, pa onda pacijenta koji treba da se ukloni
      </p>
      
      <div class="assign-form">
        <!-- Doktor Autocomplete -->
        <div class="form-group autocomplete-container">
          <label>üë®‚Äç‚öïÔ∏è Doktor</label>
          
          <!-- Izabrani doktor -->
          <div *ngIf="selectedRemoveDoctor" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>Dr. {{ selectedRemoveDoctor.firstName }} {{ selectedRemoveDoctor.lastName }}</strong>
                <span>{{ selectedRemoveDoctor.email }}</span>
                <span class="specialization" *ngIf="selectedRemoveDoctor.specialization">
                  {{ selectedRemoveDoctor.specialization }}
                </span>
              </div>
              <button class="btn-clear" (click)="clearRemoveDoctor()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedRemoveDoctor">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email doktora..."
              (input)="onRemoveDoctorSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showRemoveDoctorDropdown && (filteredRemoveDoctors$ | async) as doctors">
              <div 
                *ngFor="let doctor of doctors" 
                class="autocomplete-item"
                (mousedown)="selectRemoveDoctor(doctor)">
                <div class="user-icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="user-details">
                  <strong>Dr. {{ doctor.firstName }} {{ doctor.lastName }}</strong>
                  <span>{{ doctor.email }}</span>
                  <span class="spec" *ngIf="doctor.specialization">{{ doctor.specialization }}</span>
                </div>
              </div>
              <div *ngIf="doctors.length === 0" class="no-results">
                Nema rezultata
              </div>
            </div>
          </div>
        </div>

        <!-- Pacijent Autocomplete - prikazuje se samo ako je doktor izabran -->
        <div class="form-group autocomplete-container" *ngIf="selectedRemoveDoctor">
          <label>üë§ Pacijent</label>
          
          <!-- Izabrani pacijent -->
          <div *ngIf="selectedRemovePatient" class="selected-user">
            <div class="user-card">
              <div class="user-info">
                <strong>{{ selectedRemovePatient.firstName }} {{ selectedRemovePatient.lastName }}</strong>
                <span>{{ selectedRemovePatient.email }}</span>
              </div>
              <button class="btn-clear" (click)="clearRemovePatient()">‚úï</button>
            </div>
          </div>

          <!-- Search input -->
          <div *ngIf="!selectedRemovePatient">
            <input 
              type="text" 
              class="form-control"
              placeholder="Kucaj ime, prezime ili email pacijenta..."
              (input)="onRemovePatientSearchChange($any($event.target).value)"
            />
            
            <!-- Autocomplete dropdown -->
            <div class="autocomplete-dropdown" *ngIf="showRemovePatientDropdown && (filteredRemovePatients$ | async) as patients">
              <div 
                *ngFor="let patient of patients" 
                class="autocomplete-item"
                (mousedown)="selectRemovePatient(patient)">
                <div class="user-icon">üë§</div>
                <div class="user-details">
                  <strong>{{ patient.firstName }} {{ patient.lastName }}</strong>
                  <span>{{ patient.email }}</span>
                </div>
              </div>
              <div *ngIf="patients.length === 0" class="no-results">
                Nema pacijenata za ovog doktora
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions" *ngIf="selectedRemoveDoctor">
          <button 
            class="btn-remove"
            [disabled]="!selectedRemovePatient || !selectedRemoveDoctor"
            (click)="removePatientFromDoctor()">
            ‚ùå Ukloni Pacijenta od Doktora
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚úèÔ∏è Izmeni Korisnika</h3>
        <button class="btn-close" (click)="closeEditModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="editUserForm" (ngSubmit)="updateUser()">
          <div class="form-row">
            <div class="form-group">
              <label>Ime *</label>
              <input type="text" formControlName="firstName" class="form-control" placeholder="Unesite ime">
              <div class="error" *ngIf="editUserForm.get('firstName')?.invalid && editUserForm.get('firstName')?.touched">
                Ime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Prezime *</label>
              <input type="text" formControlName="lastName" class="form-control" placeholder="Unesite prezime">
              <div class="error" *ngIf="editUserForm.get('lastName')?.invalid && editUserForm.get('lastName')?.touched">
                Prezime je obavezno
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Telefon</label>
              <input type="text" formControlName="phoneNumber" class="form-control" placeholder="0601234567">
            </div>

            <div class="form-group">
              <label>Datum roƒëenja</label>
              <input type="date" formControlName="dateOfBirth" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Pol</label>
              <select formControlName="gender" class="form-control">
                <option value="">Izaberi pol</option>
                <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
              </select>
            </div>

            <div class="form-group" *ngIf="selectedUserForEdit?.role === 'Doctor'">
              <label>Specijalizacija</label>
              <input type="text" formControlName="specialization" class="form-control" placeholder="Kardiolog, Neurolog...">
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn-submit" [disabled]="editUserForm.invalid || isUpdatingUser">
              {{ isUpdatingUser ? 'A≈æuriranje...' : '‚úÖ Saƒçuvaj Izmene' }}
            </button>
            <button type="button" class="btn-cancel" (click)="closeEditModal()" [disabled]="isUpdatingUser">
              ‚ùå Otka≈æi
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
