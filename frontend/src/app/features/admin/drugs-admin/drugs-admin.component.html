<div class="drugs-header">
  <h3 class="page-title">Lekovi</h3>
  <button class="btn btn-success btn-add" (click)="showLekForm = true; editLek = null">
    <i class="material-icons">add</i>
    Dodaj Lek
  </button>
</div>
<div *ngIf="showLekForm" class="card drug-form-card">
  <div class="card-header card-header-success">
    <h4 class="card-title">{{ editLek ? 'Izmeni Lek' : 'Dodaj Novi Lek' }}</h4>
    <p class="card-category">Popunite osnovne informacije o leku</p>
  </div>
  <div class="card-body">
    <form class="lek-form" (ngSubmit)="submitLekForm()" [formGroup]="lekForm">
  
  <div class="form-row">
    <div class="form-group">
      <label>Naziv leka *</label>
      <input type="text" formControlName="name" placeholder="Naziv leka" required />
    </div>

    <div class="form-group">
      <label>Tip leka *</label>
      <select formControlName="type" required>
        <option value="" disabled selected>Izaberi tip leka</option>
        <option *ngFor="let t of drugTypes" [value]="t">{{ t }}</option>
      </select>
    </div>

    <div class="form-group">
      <label>Doziranje *</label>
      <input type="text" formControlName="dosage" placeholder="Doziranje" required />
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label>Proizvođač *</label>
      <select formControlName="manufacturerId" required>
        <option value="" disabled selected>Izaberi proizvođača</option>
        <option *ngFor="let m of manufacturers" [value]="m.id">{{ m.name }}</option>
      </select>
    </div>

    <div class="form-group">
      <label>Opis</label>
      <input type="text" formControlName="description" placeholder="Opis (opciono)" />
    </div>
  </div>

  <!-- SEKCIJA ZA ALERGIJE -->
  <div class="form-group allergies-section">
    <label>Alergije leka (opciono)</label>
    <div class="allergies-checkboxes" *ngIf="(allergies$ | async) as allergies">
      <div *ngFor="let allergy of allergies" class="checkbox-item">
        <input 
          type="checkbox" 
          [id]="'allergy-' + allergy.id"
          [checked]="isAllergySelected(allergy.id)"
          (change)="toggleAllergySelection(allergy.id)">
        <label [for]="'allergy-' + allergy.id">{{ allergy.name }}</label>
      </div>
    </div>
  </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-success">
          <i class="material-icons">save</i>
          {{ editLek ? 'Sačuvaj Izmene' : 'Dodaj Lek' }}
        </button>
        <button type="button" class="btn btn-default" (click)="cancelLekForm()">
          <i class="material-icons">close</i>
          Otkaži
        </button>
      </div>
    </form>
  </div>
</div>
<div class="card">
  <div class="card-header card-header-primary">
    <h4 class="card-title">Svi Lekovi</h4>
    <p class="card-category">Kompletna lista lekova u sistemu</p>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="text-primary">
          <tr>
            <th>Naziv</th>
            <th>Tip</th>
            <th>Doziranje</th>
            <th>Opis</th>
            <th>Proizvođač</th>
            <th class="text-right">Akcije</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lek of lekovi">
            <td><strong>{{ lek.name }}</strong></td>
            <td><span class="badge badge-pill badge-info">{{ lek.type }}</span></td>
            <td>{{ lek.dosage }}</td>
            <td>{{ lek.description || '-' }}</td>
            <td>{{ lek.manufacturer?.name }}</td>
            <td class="td-actions text-right">
              <button type="button" class="btn btn-success btn-sm" (click)="viewDrugAllergies(lek)">
                <i class="material-icons">warning</i>
                Alergije
              </button>
              <button type="button" class="btn btn-info btn-sm" (click)="startEditLek(lek)">
                <i class="material-icons">edit</i>
                Izmeni
              </button>
              <button type="button" class="btn btn-danger btn-sm" (click)="deleteLek(lek)">
                <i class="material-icons">close</i>
                Obriši
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="lekovi.length === 0" class="empty-state">
      <i class="material-icons">medication</i>
      <p>Nema lekova za prikaz.</p>
    </div>
  </div>
</div>

<!-- MODAL ZA PRIKAZ ALERGIJA LEKA -->
<div class="modal-overlay" *ngIf="showAllergiesModal" (click)="closeAllergiesModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Alergije leka: {{ selectedDrugForAllergies?.name }}</h3>
      <button class="close-btn" (click)="closeAllergiesModal()">×</button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoadingDrugAllergies" class="loading">Učitavanje...</div>
      <div *ngIf="!isLoadingDrugAllergies && viewDrugAllergiesList.length === 0" class="empty-modal">
        Ovaj lek nema dodeljenih alergija.
      </div>
      <div *ngIf="!isLoadingDrugAllergies && viewDrugAllergiesList.length > 0" class="allergies-list">
        <div *ngFor="let da of viewDrugAllergiesList" class="allergy-item">
          <span class="allergy-name">{{ da.allergy?.name }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
