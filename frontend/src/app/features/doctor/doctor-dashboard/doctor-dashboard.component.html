<div class="dashboard-container" *ngIf="currentUser$ | async as currentUser">
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <h2>MediSync - Doktor</h2>
    </div>
    <div class="user-info">
      <span>Dobrodo≈°li, Dr. {{ currentUser.firstName }} {{ currentUser.lastName }}</span>
      <button class="btn-logout" (click)="logout()">Odjavi se</button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'profil'" 
      (click)="selectTab('profil')">
      Profil
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'pacijenti'" 
      (click)="selectTab('pacijenti')">
      Pacijenti
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'termini'" 
      (click)="selectTab('termini')">
      Termini
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'smene'" 
      (click)="selectTab('smene')">
      Smene
    </button>
  </nav>

  <!-- Content Area -->
  <div class="content">
    <!-- Profil Tab -->
    <div *ngIf="activeTab === 'profil'" class="tab-content">
      <div class="profile-header">
        <h3>Moj Profil</h3>
        <button 
          *ngIf="!isEditMode" 
          class="btn-edit" 
          (click)="toggleEditMode()">
          Izmeni Profil
        </button>
      </div>

      <!-- View Mode -->
      <div *ngIf="!isEditMode" class="profile-info">
        <div class="info-section">
          <h5>Liƒçni podaci</h5>
          <div class="info-row">
            <span class="label">Ime:</span>
            <span class="value">{{ currentUser.firstName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Prezime:</span>
            <span class="value">{{ currentUser.lastName }}</span>
          </div>
          <div class="info-row">
            <span class="label">Email:</span>
            <span class="value">{{ currentUser.email }}</span>
          </div>
          <div class="info-row">
            <span class="label">Telefon:</span>
            <span class="value">{{ currentUser.phoneNumber || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Datum roƒëenja:</span>
            <span class="value">{{ currentUser.dateOfBirth || 'Nije uneto' }}</span>
          </div>
          <div class="info-row">
            <span class="label">Pol:</span>
            <span class="value">{{ currentUser.gender || 'Nije uneto' }}</span>
          </div>
        </div>

        <div class="info-section">
          <h5>Profesionalni podaci</h5>
          <div class="info-row">
            <span class="label">Specijalizacija:</span>
            <span class="value">{{ currentUser.specialization || 'Nije uneto' }}</span>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditMode" class="edit-profile-form">
        <form [formGroup]="editProfileForm" (ngSubmit)="saveProfile()">
          <div class="form-section">
            <h5>Liƒçni podaci</h5>
            
            <div class="form-group">
              <label>Ime:</label>
              <input type="text" formControlName="firstName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('firstName')?.invalid && editProfileForm.get('firstName')?.touched">
                Ime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Prezime:</label>
              <input type="text" formControlName="lastName" class="form-control">
              <div class="error" *ngIf="editProfileForm.get('lastName')?.invalid && editProfileForm.get('lastName')?.touched">
                Prezime je obavezno
              </div>
            </div>

            <div class="form-group">
              <label>Telefon:</label>
              <input type="text" formControlName="phoneNumber" class="form-control">
            </div>

            <div class="form-group">
              <label>Datum roƒëenja:</label>
              <input type="date" formControlName="dateOfBirth" class="form-control">
            </div>

            <div class="form-group">
              <label>Pol:</label>
              <select formControlName="gender" class="form-control">
                <option value="">Izaberi pol</option>
                <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
              </select>
            </div>
          </div>

          <div class="form-section">
            <h5>Profesionalni podaci</h5>
            
            <div class="form-group">
              <label>Specijalizacija:</label>
              <input type="text" formControlName="specialization" class="form-control" placeholder="npr. Kardiologija">
              <div class="info-message">
                Za promenu specijalizacije obratite se administratoru
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-save" 
              [disabled]="editProfileForm.invalid || (isUpdating$ | async)">
              {{ (isUpdating$ | async) ? 'ƒåuvanje...' : 'Saƒçuvaj' }}
            </button>
            <button 
              type="button" 
              class="btn-cancel" 
              (click)="cancelEdit()"
              [disabled]="isUpdating$ | async">
              Otka≈æi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Pacijenti Tab -->
    <div *ngIf="activeTab === 'pacijenti'" class="tab-content">
      <h3>Moji Pacijenti</h3>

      <!-- Loading state -->
      <div *ngIf="isLoadingPatients" class="loading">
        <p>Uƒçitavanje pacijenata...</p>
      </div>

      <!-- Empty state -->
      <div *ngIf="!isLoadingPatients && myPatients.length === 0" class="empty-state">
        <p>Nemate dodeljenih pacijenata.</p>
      </div>

      <!-- Patients Grid -->
      <div *ngIf="!isLoadingPatients && myPatients.length > 0" class="patients-grid">
        <div *ngFor="let patient of myPatients" class="patient-card">
          <div class="patient-info">
            <h5>{{ patient.firstName }} {{ patient.lastName }}</h5>
            <p class="patient-detail">Email: {{ patient.email }}</p>
            <p class="patient-detail" *ngIf="patient.phoneNumber">Telefon: {{ patient.phoneNumber }}</p>
            <p class="patient-detail" *ngIf="patient.dateOfBirth">
              Roƒëen/a: {{ patient.dateOfBirth }}
            </p>
            <p class="patient-detail" *ngIf="patient.gender">
              {{ patient.gender === 'Male' ? 'Mu≈°ki' : patient.gender === 'Female' ? '≈Ωenski' : patient.gender }}
            </p>
          </div>
          <div class="patient-actions">
            <button class="btn-allergies" (click)="viewPatientAllergies(patient)">
              Alergije
            </button>
            <button class="btn-view-details" (click)="viewPatientDetails(patient)">
              Pogledaj preglede i terapije
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Termini Tab -->
    <div *ngIf="activeTab === 'termini'" class="tab-content">
      <div class="tab-header">
        <h3>Termini i Zakazivanja</h3>
        <button class="btn-add-block" (click)="openBlockAppointmentModal()">
          üìÖ Kreiraj Blok Termin
        </button>
      </div>
      
      <!-- Filteri -->
      <div class="filters-row">
        <div class="filter-group">
          <label for="dateFromFilter">Datum od:</label>
          <input 
            id="dateFromFilter" 
            type="date" 
            [(ngModel)]="appointmentDateFromFilter"
            (ngModelChange)="appointmentDateFrom = $event">
        </div>
        
        <div class="filter-group">
          <label for="dateToFilter">Datum do:</label>
          <input 
            id="dateToFilter" 
            type="date" 
            [(ngModel)]="appointmentDateToFilter"
            (ngModelChange)="appointmentDateTo = $event">
        </div>
        
        <div class="filter-group">
          <label for="statusFilter">Status:</label>
          <select 
            id="statusFilter" 
            [(ngModel)]="appointmentStatusFilter"
            (ngModelChange)="appointmentStatus = $event">
            <option value="">Svi</option>
            <option value="Pending">Na ƒçekanju</option>
            <option value="Approved">Odobren</option>
            <option value="Completed">Zavr≈°en</option>
            <option value="Cancelled">Otkazan</option>
            <option value="Rejected">Odbijen</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="patientFilter">Pacijent:</label>
          <select 
            id="patientFilter" 
            [(ngModel)]="appointmentPatientFilter"
            (ngModelChange)="appointmentPatient = $event">
            <option value="">Svi</option>
            <option *ngFor="let patient of myPatients" [value]="patient.id">
              {{ patient.firstName }} {{ patient.lastName }}
            </option>
          </select>
        </div>
        
        <button class="btn-reset" (click)="resetAppointmentFilters()">Resetuj filtere</button>
      </div>
      
      <div *ngIf="isLoadingAppointments" class="loading">Uƒçitavanje termina...</div>
      
      <!-- Prikaz filtriranih termina -->
      <div *ngIf="!isLoadingAppointments && (filteredAppointments$ | async) as appointments">
        <div *ngIf="appointments.length === 0" class="empty">
          Nema termina koji odgovaraju filterima.
        </div>
        
        <div *ngIf="appointments.length > 0" class="appointments-list">
          <div *ngFor="let apt of appointments" class="appointment-item" [class.block-appointment]="apt.isBlockAppointment">
            <div class="appointment-row">
              <div class="appointment-info">
                <span class="patient-name">
                  {{ apt.patient?.firstName }} {{ apt.patient?.lastName }}
                  <span *ngIf="!apt.patientId" class="no-patient">(Bez pacijenta)</span>
                </span>
                
                <!-- Vreme - prika≈æi opseg za blok termine -->
                <span class="appointment-time">
                  {{ apt.startTime }}
                  <span *ngIf="apt.isBlockAppointment"> - {{ apt.endTime }}</span>
                </span>
                
                <span class="appointment-date">{{ apt.date }}</span>
                
                <span class="appointment-status" 
                      [class.status-pending]="apt.status === 'Pending'"
                      [class.status-approved]="apt.status === 'Approved'"
                      [class.status-completed]="apt.status === 'Completed'"
                      [class.status-cancelled]="apt.status === 'Cancelled'"
                      [class.status-rejected]="apt.status === 'Rejected'">
                  {{ apt.status === 'Pending' ? 'Na ƒçekanju' : 
                     apt.status === 'Approved' ? 'Odobren' : 
                     apt.status === 'Completed' ? 'Zavr≈°en' : 
                     apt.status === 'Cancelled' ? 'Otkazan' : 
                     apt.status === 'Rejected' ? 'Odbijen' : apt.status }}
                </span>
                <span class="appointment-reason" *ngIf="apt.reason">
                  {{ apt.reason }}
                </span>
              </div>
              <div class="appointment-actions">
                <!-- Pending termine mo≈æe≈° samo odobriti ili odbiti -->
                <button class="btn-approve" *ngIf="apt.status === 'Pending'" (click)="approveAppointment(apt.id)">Odobri</button>
                <button class="btn-reject" *ngIf="apt.status === 'Pending'" (click)="rejectAppointment(apt.id)">Odbij</button>
                
                <!-- Approved termine mo≈æe≈° otkazati ili zavr≈°iti -->
                <button class="btn-cancel" *ngIf="apt.status === 'Approved'" (click)="cancelAppointment(apt.id)">Otka≈æi</button>
                <button class="btn-complete" *ngIf="apt.status === 'Approved'" (click)="finishAppointment(apt.id)">Zavr≈°i</button>
                
                <!-- Completed termine - samo terapija -->
                <button class="btn-therapy" *ngIf="apt.status === 'Completed'" (click)="openTherapyModal(apt)">Dodaj terapiju</button>
                <button class="btn-follow-up" *ngIf="apt.status === 'Completed'" (click)="openFollowUpModal(apt)">Kontrolni pregled</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stari prikaz - mo≈æe se obrisati -->
      <div *ngIf="false">
        <!-- Zahtevi za termine -->
        <section>
          <h4>Zahtevi za termine</h4>
          <div *ngIf="pendingAppointments.length === 0" class="empty">Nema zahteva za termine.</div>
          <div *ngIf="pendingAppointments.length > 0" class="appointments-list">
            <div *ngFor="let apt of pendingAppointments" class="appointment-item">
              <div class="appointment-row">
                <div class="appointment-info">
                  <span class="patient-name">{{ apt.patient?.firstName }} {{ apt.patient?.lastName }}</span>
                  <span class="appointment-time">{{ apt.timeSlot }}</span>
                  <span class="appointment-date">{{ apt.date }}</span>
                  <span class="appointment-status status-pending">Na ƒçekanju</span>
                </div>
                <div class="appointment-actions">
                  <button class="btn-approve" (click)="approveAppointment(apt.id)">Odobri</button>
                  <button class="btn-reject" (click)="rejectAppointment(apt.id)">Odbij</button>
                </div>
              </div>
            </div>
          </div>
        </section>
        <hr />
        <!-- Zakazani termini -->
        <section>
          <h4>Zakazani termini</h4>
          <label for="scheduled-date-picker">Izaberi datum:</label>
          <input id="scheduled-date-picker" type="date" (change)="onScheduledDateChange($event)" [value]="selectedScheduledDate" />
          <button *ngIf="selectedScheduledDate" (click)="selectedScheduledDate = ''">Prika≈æi sve</button>
          <div *ngIf="(scheduledAppointments | filterByDate:selectedScheduledDate).length === 0" class="empty">
            Nema zakazanih termina.
          </div>
          <div *ngIf="(scheduledAppointments | filterByDate:selectedScheduledDate).length > 0" class="appointments-list">
            <!-- Blok termin (npr. operacija) -->
            <div *ngFor="let apt of scheduledAppointments | filterByDate:selectedScheduledDate" class="appointment-item">
              
              <!-- Blok termin -->
              <div *ngIf="apt.isBlock" class="appointment-row">
                <div class="appointment-info">
                  <span class="patient-name">{{ apt.patient?.firstName }} {{ apt.patient?.lastName }}</span>
                  <span class="appointment-time">{{ apt.startTime }} - {{ apt.endTime }}</span>
                  <span class="appointment-date">{{ apt.date }}</span>
                  <span class="appointment-status" [class.status-completed]="apt.status === 'Completed'" [class.status-approved]="apt.status === 'Approved'">
                    {{ apt.status === 'Approved' ? 'Zakazan' : apt.status === 'Completed' ? 'Zavr≈°en' : apt.status }}
                  </span>
                  <span class="appointment-reason">{{ apt.reason }}</span>
                </div>
                <div class="appointment-actions">
                  <button class="btn-cancel" *ngIf="apt.status === 'Approved'" (click)="cancelAppointment(apt.id)">Otka≈æi</button>
                  <button class="btn-complete" *ngIf="apt.status === 'Approved'" (click)="finishAppointment(apt.id)">Zavr≈°i</button>
                  
                  <button class="btn-therapy" *ngIf="apt.status === 'Completed'" (click)="openTherapyModal(apt)">Dodaj terapiju</button>
                  <button class="btn-follow-up" (click)="openFollowUpModal(apt)">Kontrolni pregled</button>
                </div>
              </div>

              <!-- Obiƒçni termin -->
              <div *ngIf="!apt.isBlock" class="appointment-row">
                <div class="appointment-info">
                  <span class="patient-name">{{ apt.patient?.firstName }} {{ apt.patient?.lastName }}</span>
                  <span class="appointment-time">{{ apt.timeSlot }}</span>
                  <span class="appointment-date">{{ apt.date }}</span>
                  <span class="appointment-status" [class.status-completed]="apt.status === 'Completed'" [class.status-approved]="apt.status === 'Approved'">
                    {{ apt.status === 'Approved' ? 'Zakazan' : apt.status === 'Completed' ? 'Zavr≈°en' : apt.status }}
                  </span>
                </div>
                <div class="appointment-actions">
                  <button class="btn-cancel" *ngIf="apt.status === 'Approved'" (click)="cancelAppointment(apt.id)">Otka≈æi</button>
                  <button class="btn-complete" *ngIf="apt.status === 'Approved'" (click)="finishAppointment(apt.id)">Zavr≈°i</button>
                  
                  <button class="btn-therapy" *ngIf="apt.status === 'Completed'" (click)="openTherapyModal(apt)">Dodaj terapiju</button>
                  <button class="btn-follow-up" (click)="openFollowUpModal(apt)">Kontrolni pregled</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Smene Tab -->
    <div *ngIf="activeTab === 'smene'" class="tab-content">
      <h3>Moje Smene</h3>
      
      <app-schedule-calendar
        [schedules]="mySchedules"
        [loading]="isLoadingSchedules"
        [selectedMonth]="selectedMonth"
        (monthChange)="onMonthChange($event)">
      </app-schedule-calendar>
    </div>
  </div>

  <!-- Therapy Modal -->
  <div *ngIf="showTherapyModal" class="modal-overlay" (click)="closeTherapyModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Dodaj terapiju</h3>
        <button class="btn-close" (click)="closeTherapyModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="therapyForm">
          <div class="form-group">
            <label for="diagnosis">Dijagnoza *</label>
            <textarea 
              id="diagnosis" 
              formControlName="diagnosis" 
              rows="3" 
              placeholder="Unesite dijagnozu..."></textarea>
          </div>

          <div class="form-group">
            <label for="notes">Napomene</label>
            <textarea 
              id="notes" 
              formControlName="notes" 
              rows="2" 
              placeholder="Dodatne napomene (opcionalno)..."></textarea>
          </div>

          <div class="form-group">
            <label>Lekovi *</label>
            <div formArrayName="drugs">
              <div *ngFor="let drug of drugsArray.controls; let i = index" [formGroupName]="i" class="drug-row">
                <select formControlName="drugId" class="drug-select">
                  <option value="">Izaberi lek...</option>
                  <option *ngFor="let d of allDrugs$ | async" [value]="d.id" [class.allergic-drug]="isPatientAllergicToDrug(d.id)">
                    <span *ngIf="isPatientAllergicToDrug(d.id)">‚ö†Ô∏è </span>{{ d.name }} ({{ d.dosage }})
                  </option>
                </select>
                <div class="input-with-label">
                  <input type="number" formControlName="timesPerDay" placeholder="Puta dnevno" min="1" />
                  <span class="input-suffix">x dnevno</span>
                </div>
                <div class="input-with-label">
                  <input type="number" formControlName="durationDays" placeholder="Broj dana" min="1" />
                  <span class="input-suffix">dana</span>
                </div>
                <input type="text" formControlName="instructions" placeholder="Instrukcije (opcionalno)" />
                <button type="button" class="btn-remove-drug" (click)="removeDrugRow(i)" *ngIf="drugsArray.length > 1">‚úï</button>
              </div>
            </div>
            <button type="button" class="btn-add-drug" (click)="addDrugRow()">+ Dodaj lek</button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel-modal" (click)="closeTherapyModal()">Otka≈æi</button>
        <button class="btn-submit-therapy" (click)="submitTherapy()" [disabled]="isSubmittingTherapy || therapyForm.invalid">
          {{ isSubmittingTherapy ? 'ƒåuvanje...' : 'Saƒçuvaj terapiju' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Patient Details Modal -->
<div class="modal-overlay" *ngIf="showPatientDetailsModal" (click)="closePatientDetailsModal()">
  <div class="modal-box patient-details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ selectedPatient?.firstName }} {{ selectedPatient?.lastName }} - Pregledi i terapije</h3>
      <button class="modal-close" (click)="closePatientDetailsModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Loading -->
      <div *ngIf="isLoadingPatientDetails" class="loading">
        Uƒçitavanje...
      </div>

      <!-- Combined Appointments & Therapies View -->
      <div *ngIf="!isLoadingPatientDetails">
        <div *ngIf="patientAppointmentsWithTherapies.length === 0" class="empty-state">
          <p>Pacijent nema zavr≈°enih pregleda.</p>
        </div>
        
        <div *ngIf="patientAppointmentsWithTherapies.length > 0" class="appointments-therapies-list">
          <div *ngFor="let appointment of patientAppointmentsWithTherapies" class="appointment-therapy-card">
            <!-- Pregled Info -->
            <div class="appointment-section">
              <div class="appointment-header">
                <h5>Pregled</h5>
                <span class="appointment-date">{{ appointment.date }} | {{ appointment.timeSlot }}</span>
              </div>
              <p *ngIf="appointment.reason">
                <strong>Razlog:</strong> {{ appointment.reason }}
              </p>
              <p *ngIf="appointment.notes">
                <strong>Napomene:</strong> {{ appointment.notes }}
              </p>
            </div>

            <!-- Therapy Info (ako postoji) -->
            <div *ngIf="appointment.therapy" class="therapy-section">
              <div class="therapy-header">
                <h6>Propisana terapija</h6>
                <span class="therapy-date">{{ appointment.therapy.prescribedAt | date:'dd.MM.yyyy HH:mm' }}</span>
              </div>
              <p class="therapy-diagnosis">
                <strong>Dijagnoza:</strong> {{ appointment.therapy.diagnosis }}
              </p>
              <p *ngIf="appointment.therapy.notes" class="therapy-notes">
                <strong>Napomene:</strong> {{ appointment.therapy.notes }}
              </p>
              <div class="therapy-drugs" *ngIf="appointment.therapy.therapyDrugs && appointment.therapy.therapyDrugs.length > 0">
                <strong>Lekovi:</strong>
                <ul>
                  <li *ngFor="let td of appointment.therapy.therapyDrugs">
                    <strong>{{ td.drug?.name }}</strong> ({{ td.drug?.dosage }}) - 
                    {{ td.timesPerDay }}x dnevno, {{ td.durationDays }} dana
                    <span *ngIf="td.instructions"> - <em>{{ td.instructions }}</em></span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- No therapy indicator -->
            <div *ngIf="!appointment.therapy" class="no-therapy">
              <p><em>Nije propisana terapija za ovaj pregled.</em></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel-modal" (click)="closePatientDetailsModal()">Zatvori</button>
    </div>
  </div>
</div>

<!-- Follow-up Appointment Modal -->
<div class="modal-overlay" *ngIf="showFollowUpModal" (click)="closeFollowUpModal()">
  <div class="modal-box follow-up-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Zaka≈æi kontrolni pregled</h3>
      <button class="modal-close" (click)="closeFollowUpModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="patient-info-box">
        <p><strong>Pacijent:</strong> {{ selectedAppointmentForFollowUp?.patient?.firstName }} {{ selectedAppointmentForFollowUp?.patient?.lastName }}</p>
        <p><strong>Originalni pregled:</strong> {{ selectedAppointmentForFollowUp?.date }} u {{ selectedAppointmentForFollowUp?.timeSlot }}</p>
      </div>
      
      <form [formGroup]="followUpForm">
        <div class="form-group">
          <label for="followup-date">Datum kontrolnog pregleda *</label>
          <input 
            type="date" 
            id="followup-date" 
            formControlName="date"
            [min]="minFollowUpDate"
            (change)="onFollowUpDateChange($event)">
          <div class="error" *ngIf="followUpForm.get('date')?.invalid && followUpForm.get('date')?.touched">
            Datum je obavezan
          </div>
        </div>

        <div class="form-group">
          <label for="followup-time">Termin *</label>
          <div *ngIf="isLoadingTimeSlots" class="loading-slots">
            Uƒçitavanje slobodnih termina...
          </div>
          <select 
            *ngIf="!isLoadingTimeSlots" 
            id="followup-time" 
            formControlName="timeSlot"
            [disabled]="availableTimeSlots.length === 0">
            <option value="">Izaberi termin...</option>
            <option *ngIf="availableTimeSlots.length === 0" value="" disabled>
              Nema slobodnih termina za izabrani datum
            </option>
            <option *ngFor="let slot of availableTimeSlots" [value]="slot">
              {{ slot.replace('_', ':') }}
            </option>
          </select>
          <div class="error" *ngIf="followUpForm.get('timeSlot')?.invalid && followUpForm.get('timeSlot')?.touched">
            Termin je obavezan
          </div>
          <div class="info" *ngIf="!isLoadingTimeSlots && availableTimeSlots.length === 0">
            Nema slobodnih termina za izabrani datum. Izaberite drugi datum ili kreirajte novu smenu.
          </div>
        </div>

        <div class="form-group">
          <label for="followup-reason">Razlog kontrolnog pregleda</label>
          <textarea 
            id="followup-reason" 
            formControlName="reason"
            placeholder="Npr: Kontrola terapije, pregled rezultata..."
            rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="followup-notes">Napomene</label>
          <textarea 
            id="followup-notes" 
            formControlName="notes"
            placeholder="Dodatne napomene..."
            rows="2"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel-modal" (click)="closeFollowUpModal()">Otka≈æi</button>
      <button class="btn-submit-therapy" (click)="submitFollowUp()" [disabled]="isSubmittingFollowUp || followUpForm.invalid">
        {{ isSubmittingFollowUp ? 'Zakazivanje...' : 'Zaka≈æi pregled' }}
      </button>
    </div>
  </div>
</div>

<!-- Blok Termin Modal -->
<div *ngIf="showBlockAppointmentModal" class="modal-overlay" (click)="closeBlockAppointmentModal()">
  <div class="modal-content block-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üè• Kreiraj Blok Termin</h3>
      <button class="btn-close" (click)="closeBlockAppointmentModal()">‚úï</button>
    </div>
    
    <form [formGroup]="blockAppointmentForm" (ngSubmit)="submitBlockAppointment()" class="modal-body">
      <!-- Patient Selection (Required) -->
      <div class="form-group">
        <label for="blockPatientId">Pacijent *</label>
        <select id="blockPatientId" formControlName="patientId">
          <option value="">-- Izaberi pacijenta --</option>
          <option *ngFor="let patient of allPatients" [value]="patient.id">
            {{ patient.firstName }} {{ patient.lastName }}
          </option>
        </select>
        <div class="error" *ngIf="blockAppointmentForm.get('patientId')?.invalid && blockAppointmentForm.get('patientId')?.touched">
          Pacijent je obavezan za blok termin
        </div>
        <small class="field-hint">Svi pacijenti u sistemu su dostupni za izbor (operacije mogu ukljuƒçivati vi≈°e doktora)</small>
      </div>

      <!-- Date -->
      <div class="form-group">
        <label for="blockDate">Datum *</label>
        <input type="date" id="blockDate" formControlName="date" required>
      </div>

      <!-- Start Time -->
      <div class="form-group">
        <label for="blockStartTime">Poƒçetno vreme *</label>
        <div *ngIf="isLoadingStartTimes" class="loading-slots">
          ‚è≥ Uƒçitavanje slobodnih slotova...
        </div>
        <select 
          *ngIf="!isLoadingStartTimes" 
          id="blockStartTime" 
          formControlName="startTime" 
          required>
          <option value="">-- Izaberi poƒçetno vreme --</option>
          <option *ngFor="let slot of availableStartTimes" [value]="slot">
            {{ slot }}
          </option>
        </select>
        <small class="field-hint" *ngIf="availableStartTimes.length > 0">
          Prvi slot blok termina - dostupno {{ availableStartTimes.length }} slobodnih slotova
        </small>
        <small class="field-hint field-warning" *ngIf="availableStartTimes.length === 0 && !isLoadingStartTimes && blockAppointmentForm.get('date')?.value">
          ‚ö†Ô∏è Nema slobodnih slotova za izabrani datum
        </small>
      </div>

      <!-- Number of Slots -->
      <div class="form-group">
        <label for="blockSlots">Broj slotova *</label>
        <input 
          type="number" 
          id="blockSlots" 
          formControlName="numberOfSlots" 
          min="1" 
          max="16" 
          required>
        <small class="field-hint">
          1 slot = 30 minuta | Ukupno trajanje: {{ blockAppointmentForm.get('numberOfSlots')?.value * 0.5 || 0 }}h
        </small>
      </div>

      <!-- Reason -->
      <div class="form-group">
        <label for="blockReason">Razlog/Tip zahvata *</label>
        <input 
          type="text" 
          id="blockReason" 
          formControlName="reason" 
          placeholder="npr. OPERACIJA, HIRURGIJA, PREGLED..."
          required>
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label for="blockNotes">Napomena</label>
        <textarea 
          id="blockNotes" 
          formControlName="notes" 
          rows="3" 
          placeholder="Dodatne napomene o blok terminu..."></textarea>
      </div>

      <!-- Submit -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn-cancel" 
          (click)="closeBlockAppointmentModal()"
          [disabled]="isSubmittingBlockAppointment">
          Otka≈æi
        </button>
        <button 
          type="submit" 
          class="btn-submit" 
          [disabled]="blockAppointmentForm.invalid || isSubmittingBlockAppointment">
          <span *ngIf="!isSubmittingBlockAppointment">üìÖ Kreiraj Blok Termin</span>
          <span *ngIf="isSubmittingBlockAppointment">‚è≥ Kreiranje...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal za Alergije Pacijenta -->
<div class="modal-overlay" *ngIf="showPatientAllergiesModal" (click)="closePatientAllergiesModal()">
  <div class="modal-content allergies-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Alergije pacijenta: {{ selectedPatientForAllergies?.firstName }} {{ selectedPatientForAllergies?.lastName }}</h3>
      <button class="close-btn" (click)="closePatientAllergiesModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoadingPatientAllergies" class="loading">Uƒçitavanje...</div>
      <div *ngIf="!isLoadingPatientAllergies && patientAllergiesList.length === 0" class="empty-modal">
        ‚ö†Ô∏è Ovaj pacijent nema evidentirane alergije.
      </div>
      <div *ngIf="!isLoadingPatientAllergies && patientAllergiesList.length > 0" class="allergies-list">
        <div *ngFor="let pa of patientAllergiesList" class="allergy-item">
          <div class="allergy-icon">‚ö†Ô∏è</div>
          <div class="allergy-info">
            <span class="allergy-name">{{ pa.allergy?.name }}</span>
            <span class="diagnosed-date" *ngIf="pa.diagnosedDate">
              Dijagnostikovano: {{ pa.diagnosedDate | date:'dd.MM.yyyy' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Component -->
<app-chat></app-chat>
